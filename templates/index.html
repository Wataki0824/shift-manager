<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™è¡¨è‡ªå‹•ç”Ÿæˆ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“… å‹¤å‹™è¡¨è‡ªå‹•ç”Ÿæˆ</h1>
            <p class="subtitle">å¹´æœˆãƒ»ã‚«ãƒ¡ãƒ©ãƒãƒ³ãƒ»ä¼‘ã¿ã‚’å…¥åŠ›ã—ã¦å‹¤å‹™è¡¨ã‚’è‡ªå‹•ç”Ÿæˆ</p>
        </header>

        <main>
            <!-- Step 1: å¹´æœˆé¸æŠ -->
            <section class="form-section">
                <h2 class="section-title">1. å¹´æœˆã‚’é¸æŠ</h2>
                <div class="date-selector">
                    <select id="yearSelect" class="select-input">
                        <!-- JSã§ç”Ÿæˆ -->
                    </select>
                    <span class="date-separator">å¹´</span>
                    <select id="monthSelect" class="select-input">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <span class="date-separator">æœˆ</span>
                </div>
            </section>

            <!-- Step 2: ã‚«ãƒ¡ãƒ©ãƒãƒ³åå…¥åŠ› -->
            <section class="form-section">
                <h2 class="section-title">2. ã‚«ãƒ¡ãƒ©ãƒãƒ³åã¨ç›®æ¨™å…¬ä¼‘æ•°ã‚’å…¥åŠ›</h2>
                <div class="staff-inputs">
                    <div class="staff-input-row">
                        <label>ã‚«ãƒ¡ãƒ©ãƒãƒ³1:</label>
                        <input type="text" id="staff1" class="text-input" value="A" placeholder="åå‰">
                        <div class="holiday-select-wrapper">
                            <label class="holiday-label">å…¬ä¼‘æ•°:</label>
                            <select id="staff1Holidays" class="select-input holiday-select"></select>
                        </div>
                    </div>
                    <div class="staff-input-row">
                        <label>ã‚«ãƒ¡ãƒ©ãƒãƒ³2:</label>
                        <input type="text" id="staff2" class="text-input" value="B" placeholder="åå‰">
                        <div class="holiday-select-wrapper">
                            <label class="holiday-label">å…¬ä¼‘æ•°:</label>
                            <select id="staff2Holidays" class="select-input holiday-select"></select>
                        </div>
                    </div>
                    <div class="staff-input-row">
                        <label>ã‚«ãƒ¡ãƒ©ãƒãƒ³3:</label>
                        <input type="text" id="staff3" class="text-input" value="C" placeholder="åå‰">
                        <div class="holiday-select-wrapper">
                            <label class="holiday-label">å…¬ä¼‘æ•°:</label>
                            <select id="staff3Holidays" class="select-input holiday-select"></select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 3: ä¼‘ã¿å…¥åŠ›ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
            <section class="form-section">
                <h2 class="section-title">3. ä¼‘ã¿ãƒ»ã‚·ãƒ•ãƒˆå›ºå®šãƒ»äººæ•°æŒ‡å®š</h2>
                <div class="alert-info">
                    å„ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥åŠ›ã—ã¾ã™ã€‚ã¾ãŸã€å³ç«¯ã®åˆ—ã§ãã®æ—¥ã®å‡ºå‹¤äººæ•°ã‚’æŒ‡å®šã§ãã¾ã™(3ã‚«ãƒ¡ç­‰)ã€‚
                </div>

                <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
                <div class="toolbar">
                    <span class="toolbar-label">å…¥åŠ›ãƒ„ãƒ¼ãƒ«:</span>
                    <button class="tool-btn active" onclick="selectTool(this, '')">ğŸ§¹ æ¶ˆå»</button>
                    <button class="tool-btn" onclick="selectTool(this, 'å…¬')">å…¬</button>
                    <button class="tool-btn" onclick="selectTool(this, 'å¹´')">å¹´</button>
                    <button class="tool-btn" onclick="selectTool(this, '9')">9æ™‚</button>
                    <button class="tool-btn" onclick="selectTool(this, '10')">10æ™‚</button>
                </div>

                <div class="calendar-container">
                    <table class="calendar-table" id="calendarTable">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>æ›œæ—¥</th>
                                <th id="staffHeader1">A</th>
                                <th id="staffHeader2">B</th>
                                <th id="staffHeader3">C</th>
                                <th>å‡ºå‹¤äººæ•°</th>
                                <th>äºˆå®š</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- JSã§ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </section>

            <script>
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
                let currentTool = ''; // ''(æ¶ˆå»), 'å…¬', 'å¹´', '9', '10'
                let headcountData = {}; // {day: count}
                let memoData = {}; // {day: string}

                function selectTool(btn, val) {
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTool = val;
                }

                function updateHeadcount(day, val) {
                    headcountData[day] = parseInt(val);
                }

                function updateMemo(day, val) {
                    memoData[day] = val;
                }
            </script>


            <!-- ç”Ÿæˆãƒœã‚¿ãƒ³ -->
            <section class="action-section">
                <button id="generateBtn" class="btn btn-primary">
                    ğŸš€ å‹¤å‹™è¡¨ã‚’ç”Ÿæˆ
                </button>
            </section>

            <!-- çµæœè¡¨ç¤º -->
            <section class="result-section" id="resultSection" style="display: none;">
                <div class="result-card">
                    <h2>âœ… ç”Ÿæˆå®Œäº†</h2>
                    <p class="attempts" id="attempts"></p>

                    <div class="y-counts">
                        <h3>å‘¼ã³å‡ºã—ï¼ˆYï¼‰é›†è¨ˆ</h3>
                        <div id="yCounts"></div>
                    </div>

                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="preview-section">
                        <h3>ğŸ“‹ ç”Ÿæˆçµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                        <div class="calendar-container">
                            <table class="calendar-table preview-table" id="previewTable">
                                <thead id="previewHead"></thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <button id="downloadBtn" class="btn btn-success">
                        ğŸ“¥ Excelã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </section>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
            <section class="error-section" id="errorSection" style="display: none;">
                <div class="error-card">
                    <h2>âŒ ã‚¨ãƒ©ãƒ¼</h2>
                    <p id="errorMessage"></p>
                </div>
            </section>
        </main>

        <footer>
            <p>Â© 2026 å‹¤å‹™è¡¨è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</p>
        </footer>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p>ç”Ÿæˆä¸­...</p>
    </div>

    <script>
        const DAY_NAMES = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const OFF_TYPES = ['', 'å…¬', 'å¹´'];

        // è¦ç´ å–å¾—
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const staff1Input = document.getElementById('staff1');
        const staff2Input = document.getElementById('staff2');
        const staff3Input = document.getElementById('staff3');
        const calendarBody = document.getElementById('calendarBody');
        const generateBtn = document.getElementById('generateBtn');
        const resultSection = document.getElementById('resultSection');
        const errorSection = document.getElementById('errorSection');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // åˆæœŸåŒ–
        function init() {
            // å¹´ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 3; y <= currentYear + 3; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            // ç¾åœ¨ã®æœˆã‚’é¸æŠ
            const currentMonth = new Date().getMonth() + 1;
            monthSelect.value = currentMonth;

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ
            generateCalendar();

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            yearSelect.addEventListener('change', generateCalendar);
            monthSelect.addEventListener('change', generateCalendar);
            staff1Input.addEventListener('input', updateStaffHeaders);
            staff2Input.addEventListener('input', updateStaffHeaders);
            staff3Input.addEventListener('input', updateStaffHeaders);
        }

        // ã‚«ãƒ¡ãƒ©ãƒãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
        function updateStaffHeaders() {
            document.getElementById('staffHeader1').textContent = staff1Input.value || 'A';
            document.getElementById('staffHeader2').textContent = staff2Input.value || 'B';
            document.getElementById('staffHeader3').textContent = staff3Input.value || 'C';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ & å…¬ä¼‘æ•°æ›´æ–°
        function generateCalendar() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const daysInMonth = new Date(year, month, 0).getDate();

            calendarBody.innerHTML = '';

            let weekendCount = 0;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                const dayName = DAY_NAMES[dayOfWeek];
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                if (isWeekend) weekendCount++;

                const row = document.createElement('tr');
                if (isWeekend) row.classList.add('weekend-row');

                // äººæ•°æŒ‡å®šã‚»ãƒ¬ã‚¯ãƒˆã®HTMLç”Ÿæˆ
                const currentHeadcount = headcountData[day] || 0;
                const headcountSelect = `
                    <select onchange="updateHeadcount(${day}, this.value)" class="headcount-select" style="width:100%; min-width:60px;">
                        <option value="0" ${currentHeadcount == 0 ? 'selected' : ''}>è‡ªå‹•</option>
                        <option value="1" ${currentHeadcount == 1 ? 'selected' : ''}>1äºº</option>
                        <option value="2" ${currentHeadcount == 2 ? 'selected' : ''}>2äºº</option>
                        <option value="3" ${currentHeadcount == 3 ? 'selected' : ''}>3äºº</option>
                    </select>
                `;

                // ãƒ¡ãƒ¢å…¥åŠ›
                const currentMemo = memoData[day] || '';
                const memoInput = `<input type="text" class="memo-input" style="width:100%; border:none; background:transparent; padding:4px;" onchange="updateMemo(${day}, this.value)" value="${currentMemo}" placeholder="äºˆå®š">`;

                row.innerHTML = `
                    <td class="day-cell">${day}</td>
                    <td class="day-name-cell ${isWeekend ? 'weekend' : ''}">${dayName}</td>
                    <td class="off-cell" data-day="${day}" data-staff="1"></td>
                    <td class="off-cell" data-day="${day}" data-staff="2"></td>
                    <td class="off-cell" data-day="${day}" data-staff="3"></td>
                    <td>${headcountSelect}</td>
                    <td style="padding:0;">${memoInput}</td>
                `;

                calendarBody.appendChild(row);
            }

            // ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒšãƒ³ãƒ„ãƒ¼ãƒ«æ–¹å¼)
            document.querySelectorAll('.off-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    cell.textContent = currentTool;
                    cell.className = 'off-cell'; // ã‚¯ãƒ©ã‚¹ãƒªã‚»ãƒƒãƒˆ
                    if (currentTool === 'å…¬') cell.classList.add('off-public');
                    if (currentTool === 'å¹´') cell.classList.add('off-annual');
                    if (currentTool === '9') cell.classList.add('shift-9');
                    if (currentTool === '10') cell.classList.add('shift-10');
                });
            });

            // å…¬ä¼‘æ•°ã®é¸æŠè‚¢ã‚’æ›´æ–°
            updateHolidaySelects(weekendCount);
        }

        // å…¬ä¼‘æ•°é¸æŠè‚¢ã®æ›´æ–°
        function updateHolidaySelects(weekendCount) {
            const minHolidays = Math.max(0, weekendCount - 8);
            const maxHolidays = weekendCount + 8;

            const selects = [
                document.getElementById('staff1Holidays'),
                document.getElementById('staff2Holidays'),
                document.getElementById('staff3Holidays')
            ];

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                for (let i = minHolidays; i <= maxHolidays; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}æ—¥`;
                    if (i === weekendCount) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
                if (currentValue && currentValue >= minHolidays && currentValue <= maxHolidays) {
                    select.value = currentValue;
                }
            });
        }

        // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        function collectInputData() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const staffNames = [
                staff1Input.value || 'A',
                staff2Input.value || 'B',
                staff3Input.value || 'C'
            ];

            const daysInMonth = new Date(year, month, 0).getDate();
            const scheduleData = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayName = DAY_NAMES[date.getDay()];

                const dayData = {
                    day: day,
                    dayOfWeek: dayName,
                    staff: {}
                };

                for (let s = 1; s <= 3; s++) {
                    const cell = document.querySelector(`.off-cell[data-day="${day}"][data-staff="${s}"]`);
                    dayData.staff[staffNames[s - 1]] = cell.textContent;
                }

                scheduleData.push(dayData);
            }

            return {
                year: year,
                month: month,
                holidayCount: parseInt(document.getElementById('staff1Holidays').value) || 8,
                staffNames: staffNames,
                schedule: scheduleData,
                staffNames: staffNames,
                schedule: scheduleData,
                headcount: headcountData,
                memo: memoData
            };
        }

        // ç”Ÿæˆãƒœã‚¿ãƒ³
        generateBtn.addEventListener('click', async () => {
            const data = collectInputData();

            // UIãƒªã‚»ãƒƒãƒˆ
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
            loadingOverlay.style.display = 'flex';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showResult(result);
                } else {
                    showError(result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (err) {
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        function showResult(data) {
            if (data.filename) {
                resultSection.dataset.filename = data.filename;
            }

            const yCountsDiv = document.getElementById('yCounts');
            yCountsDiv.innerHTML = '';

            // è©³ç´°é›†è¨ˆè¡¨ç¤º
            if (data.detailed_counts) {
                const table = document.createElement('table');
                table.className = 'counts-table';

                const thead = document.createElement('thead');
                thead.innerHTML = '<tr><th>åå‰</th><th>Y</th><th>9</th><th>10</th><th>å…¬</th><th>å¹´</th></tr>';
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                for (const staffName of data.staffNames) {
                    const counts = data.detailed_counts[staffName] || {};
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="font-bold">${staffName}</td>
                        <td class="count-y">${counts['Y'] || 0}</td>
                        <td>${counts['9'] || 0}</td>
                        <td>${counts['10'] || 0}</td>
                        <td>${counts['å…¬'] || 0}</td>
                        <td>${counts['å¹´'] || 0}</td>
                    `;
                    tbody.appendChild(tr);
                }
                table.appendChild(tbody);
                yCountsDiv.appendChild(table);
            }

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
            const previewHead = document.getElementById('previewHead');
            const previewBody = document.getElementById('previewBody');

            previewHead.innerHTML = `
                <tr>
                    <th>æ—¥ä»˜</th>
                    <th>æ›œæ—¥</th>
                    ${data.staffNames.map(name => `<th colspan="2">${name}</th>`).join('')}
                    <th>äºˆå®š</th>
                </tr>
            `;

            previewBody.innerHTML = '';
            for (const row of data.preview) {
                const dayOfWeek = row.dayOfWeek;
                const isWeekend = dayOfWeek === 'åœŸ' || dayOfWeek === 'æ—¥';

                let rowHtml = `
                    <tr class="${isWeekend ? 'weekend-row' : ''}">
                        <td class="day-cell">${row.day}</td>
                        <td class="day-name-cell ${isWeekend ? 'weekend' : ''}">${dayOfWeek}</td>
                `;

                for (const staffName of data.staffNames) {
                    const staffData = row.staff[staffName] || { value: '', isRequest: false };
                    const value = staffData.value;
                    const isRequest = staffData.isRequest;

                    let yMark = '';
                    let timeValue = value;

                    if (value.startsWith('Y')) {
                        yMark = 'Y';
                        timeValue = value.substring(1);
                    } else if (value === 'å…¬' || value === 'å¹´') {
                        yMark = '';
                        timeValue = value;
                    }

                    const yClass = yMark ? 'has-y' : '';
                    const offClass = (value === 'å…¬' || value === 'å¹´') ? 'is-off' : '';
                    const requestClass = isRequest ? 'request-off' : '';

                    rowHtml += `
                        <td class="preview-cell ${yClass} editable-cell y-column-cell" onclick="toggleY(this)">${yMark}</td>
                        <td class="preview-cell ${offClass} ${requestClass} editable-cell" onclick="editTime(this)" data-original-request="${isRequest}">${timeValue}</td>
                    `;
                }

                rowHtml += '</tr>';

                // ãƒ¡ãƒ¢åˆ—ï¼ˆç·¨é›†å¯èƒ½ã«ã™ã‚‹ï¼‰
                const memoVal = row.memo || '';
                rowHtml = rowHtml.replace('</tr>', `<td class="preview-cell editable-cell memo-cell" onclick="editMemo(this)">${memoVal}</td></tr>`);

                previewBody.innerHTML += rowHtml;
            }

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // --- ç·¨é›†æ©Ÿèƒ½ ---
        function toggleY(td) {
            if (td.textContent.trim() === 'Y') {
                td.textContent = '';
                td.classList.remove('has-y');
            } else {
                td.textContent = 'Y';
                td.classList.add('has-y');
            }
        }

        function editTime(td) {
            if (td.querySelector('select')) return;

            const currentValue = td.textContent.trim();
            td.innerHTML = '';

            const select = document.createElement('select');
            select.className = 'edit-select';

            const options = ['9', '10', 'å…¬', 'å¹´'];
            if (!options.includes(currentValue) && currentValue !== '') {
                options.push(currentValue);
            }

            for (const opt of options) {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (opt === currentValue) option.selected = true;
                select.appendChild(option);
            }

            select.addEventListener('blur', () => confirmEdit(td, select));
            select.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') select.blur();
            });

            td.appendChild(select);
            select.focus();
        }

        function confirmEdit(td, select) {
            const newValue = select.value;
            td.textContent = newValue;

            td.classList.remove('is-off', 'request-off');

            if (newValue === 'å…¬' || newValue === 'å¹´') {
                td.classList.add('is-off');
                if (newValue === 'å…¬') {
                    td.classList.add('request-off');
                }
            }
        }

        // ãƒ¡ãƒ¢ç·¨é›†ç”¨
        function editMemo(td) {
            if (td.querySelector('input')) return;
            const current = td.textContent;
            td.innerHTML = '';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = current;
            input.style.width = '100%';
            input.style.border = 'none';
            input.style.background = 'transparent';

            input.addEventListener('blur', () => {
                td.textContent = input.value;
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
            });

            td.appendChild(input);
            input.focus();
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorSection.style.display = 'block';
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            const table = document.querySelector('.preview-table');
            if (!table) return;

            const staffNames = Array.from(table.querySelectorAll('thead th[colspan="2"]')).map(th => th.textContent);
            const rows = [];
            const trs = table.querySelectorAll('tbody tr');

            for (const tr of trs) {
                const day = tr.querySelector('.day-cell').textContent;
                const dayOfWeek = tr.querySelector('.day-name-cell').textContent;
                const staffData = {};
                const cells = Array.from(tr.querySelectorAll('.preview-cell'));

                for (let i = 0; i < staffNames.length; i++) {
                    const yCell = cells[i * 2];
                    const valCell = cells[i * 2 + 1];
                    const timeVal = valCell.textContent.trim();
                    const yVal = yCell.textContent.trim();
                    let fullVal = '';

                    if (timeVal === 'å…¬' || timeVal === 'å¹´') {
                        fullVal = timeVal;
                    } else {
                        fullVal = yVal + timeVal;
                    }

                    const originalRequest = valCell.dataset.originalRequest === 'true';
                    let isRequest = originalRequest;
                    if (timeVal !== 'å…¬' && timeVal !== 'å¹´') {
                        isRequest = false;
                    }

                    staffData[staffNames[i]] = {
                        value: fullVal,
                        isRequest: isRequest
                    };
                }

                rows.push({
                    day: day,
                    dayOfWeek: dayOfWeek,
                    staff: staffData,
                    memo: tr.querySelector('.memo-cell').textContent.trim()
                });
            }

            try {
                const response = await fetch('/download_edited', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rows: rows,
                        staffNames: staffNames,
                        filename: document.getElementById('resultSection').dataset.filename || 'schedule.xlsx'
                    })
                });

                if (!response.ok) {
                    throw new Error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = document.getElementById('resultSection').dataset.filename || 'å‹¤å‹™è¡¨.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (err) {
                alert(err.message);
            }
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>

</html>