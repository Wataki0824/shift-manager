<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™è¡¨è‡ªå‹•ç”Ÿæˆ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“… å‹¤å‹™è¡¨è‡ªå‹•ç”Ÿæˆ</h1>
            <p class="subtitle">å¹´æœˆãƒ»ã‚«ãƒ¡ãƒ©ãƒãƒ³ãƒ»ä¼‘ã¿ã‚’å…¥åŠ›ã—ã¦å‹¤å‹™è¡¨ã‚’è‡ªå‹•ç”Ÿæˆ</p>
        </header>

        <main>
            <!-- Step 1: å¹´æœˆé¸æŠ -->
            <section class="form-section">
                <h2 class="section-title">1. å¹´æœˆã‚’é¸æŠ</h2>
                <div class="date-selector">
                    <select id="yearSelect" class="select-input">
                        <!-- JSã§ç”Ÿæˆ -->
                    </select>
                    <span class="date-separator">å¹´</span>
                    <select id="monthSelect" class="select-input">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <span class="date-separator">æœˆ</span>
                </div>
            </section>

            <!-- Step 2: ã‚«ãƒ¡ãƒ©ãƒãƒ³åå…¥åŠ› -->
            <section class="form-section">
                <h2 class="section-title">2. ã‚«ãƒ¡ãƒ©ãƒãƒ³åã¨ç›®æ¨™å…¬ä¼‘æ•°ã‚’å…¥åŠ›</h2>
                <div class="staff-inputs">
                    <div class="staff-input-row">
                        <label>ã‚«ãƒ¡ãƒ©ãƒãƒ³1:</label>
                        <input type="text" id="staff1" class="text-input" value="A" placeholder="åå‰">
                        <div class="holiday-select-wrapper">
                            <label class="holiday-label">å…¬ä¼‘æ•°:</label>
                            <select id="staff1Holidays" class="select-input holiday-select"></select>
                        </div>
                    </div>
                    <div class="staff-input-row">
                        <label>ã‚«ãƒ¡ãƒ©ãƒãƒ³2:</label>
                        <input type="text" id="staff2" class="text-input" value="B" placeholder="åå‰">
                        <div class="holiday-select-wrapper">
                            <label class="holiday-label">å…¬ä¼‘æ•°:</label>
                            <select id="staff2Holidays" class="select-input holiday-select"></select>
                        </div>
                    </div>
                    <div class="staff-input-row">
                        <label>ã‚«ãƒ¡ãƒ©ãƒãƒ³3:</label>
                        <input type="text" id="staff3" class="text-input" value="C" placeholder="åå‰">
                        <div class="holiday-select-wrapper">
                            <label class="holiday-label">å…¬ä¼‘æ•°:</label>
                            <select id="staff3Holidays" class="select-input holiday-select"></select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 3: ä¼‘ã¿å…¥åŠ›ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
            <section class="form-section">
                <h2 class="section-title">3. ä¼‘ã¿ã‚’é¸æŠ</h2>
                <p class="help-text">å„æ—¥ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¼‘ã¿ã®ã‚¿ã‚¤ãƒ—ã‚’é¸æŠï¼ˆç©ºæ¬„â†’å…¬â†’å¹´â†’ç©ºæ¬„...ï¼‰</p>
                <div class="calendar-container">
                    <table class="calendar-table" id="calendarTable">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>æ›œæ—¥</th>
                                <th id="staffHeader1">A</th>
                                <th id="staffHeader2">B</th>
                                <th id="staffHeader3">C</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- JSã§ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ç”Ÿæˆãƒœã‚¿ãƒ³ -->
            <section class="action-section">
                <button id="generateBtn" class="btn btn-primary">
                    ğŸš€ å‹¤å‹™è¡¨ã‚’ç”Ÿæˆ
                </button>
            </section>

            <!-- çµæœè¡¨ç¤º -->
            <section class="result-section" id="resultSection" style="display: none;">
                <div class="result-card">
                    <h2>âœ… ç”Ÿæˆå®Œäº†</h2>
                    <p class="attempts" id="attempts"></p>

                    <div class="y-counts">
                        <h3>å‘¼ã³å‡ºã—ï¼ˆYï¼‰é›†è¨ˆ</h3>
                        <div id="yCounts"></div>
                    </div>

                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="preview-section">
                        <h3>ğŸ“‹ ç”Ÿæˆçµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                        <div class="calendar-container">
                            <table class="calendar-table preview-table" id="previewTable">
                                <thead id="previewHead"></thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <button id="downloadBtn" class="btn btn-success">
                        ğŸ“¥ Excelã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </section>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
            <section class="error-section" id="errorSection" style="display: none;">
                <div class="error-card">
                    <h2>âŒ ã‚¨ãƒ©ãƒ¼</h2>
                    <p id="errorMessage"></p>
                </div>
            </section>
        </main>

        <footer>
            <p>Â© 2026 å‹¤å‹™è¡¨è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</p>
        </footer>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p>ç”Ÿæˆä¸­...</p>
    </div>

    <script>
        const DAY_NAMES = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const OFF_TYPES = ['', 'å…¬', 'å¹´'];

        // è¦ç´ å–å¾—
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const staff1Input = document.getElementById('staff1');
        const staff2Input = document.getElementById('staff2');
        const staff3Input = document.getElementById('staff3');
        const calendarBody = document.getElementById('calendarBody');
        const generateBtn = document.getElementById('generateBtn');
        const resultSection = document.getElementById('resultSection');
        const errorSection = document.getElementById('errorSection');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // åˆæœŸåŒ–
        function init() {
            // å¹´ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 3; y <= currentYear + 3; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            // ç¾åœ¨ã®æœˆã‚’é¸æŠ
            const currentMonth = new Date().getMonth() + 1;
            monthSelect.value = currentMonth;

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ
            generateCalendar();

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            yearSelect.addEventListener('change', generateCalendar);
            monthSelect.addEventListener('change', generateCalendar);
            staff1Input.addEventListener('input', updateStaffHeaders);
            staff2Input.addEventListener('input', updateStaffHeaders);
            staff3Input.addEventListener('input', updateStaffHeaders);
        }

        // ã‚«ãƒ¡ãƒ©ãƒãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
        function updateStaffHeaders() {
            document.getElementById('staffHeader1').textContent = staff1Input.value || 'A';
            document.getElementById('staffHeader2').textContent = staff2Input.value || 'B';
            document.getElementById('staffHeader3').textContent = staff3Input.value || 'C';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ & å…¬ä¼‘æ•°æ›´æ–°
        function generateCalendar() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const daysInMonth = new Date(year, month, 0).getDate();

            calendarBody.innerHTML = '';

            let weekendCount = 0;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                const dayName = DAY_NAMES[dayOfWeek];
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                if (isWeekend) weekendCount++;

                const row = document.createElement('tr');
                if (isWeekend) row.classList.add('weekend-row');

                row.innerHTML = `
                    <td class="day-cell">${day}</td>
                    <td class="day-name-cell ${isWeekend ? 'weekend' : ''}">${dayName}</td>
                    <td class="off-cell" data-day="${day}" data-staff="1" data-off-index="0"></td>
                    <td class="off-cell" data-day="${day}" data-staff="2" data-off-index="0"></td>
                    <td class="off-cell" data-day="${day}" data-staff="3" data-off-index="0"></td>
                `;

                calendarBody.appendChild(row);
            }

            // ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.off-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    let index = parseInt(cell.dataset.offIndex);
                    index = (index + 1) % OFF_TYPES.length;
                    cell.dataset.offIndex = index;
                    cell.textContent = OFF_TYPES[index];

                    // ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
                    cell.classList.remove('off-public', 'off-annual');
                    if (OFF_TYPES[index] === 'å…¬') cell.classList.add('off-public');
                    if (OFF_TYPES[index] === 'å¹´') cell.classList.add('off-annual');
                });
            });

            // å…¬ä¼‘æ•°ã®é¸æŠè‚¢ã‚’æ›´æ–°
            updateHolidaySelects(weekendCount);
        }

        // å…¬ä¼‘æ•°é¸æŠè‚¢ã®æ›´æ–°
        function updateHolidaySelects(weekendCount) {
            const minHolidays = Math.max(0, weekendCount - 8);
            const maxHolidays = weekendCount + 8;

            const selects = [
                document.getElementById('staff1Holidays'),
                document.getElementById('staff2Holidays'),
                document.getElementById('staff3Holidays')
            ];

            selects.forEach(select => {
                // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒ
                const currentValue = select.value;
                select.innerHTML = '';

                for (let i = minHolidays; i <= maxHolidays; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}æ—¥`;
                    if (i === weekendCount) {
                        option.selected = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åŸºæº–å€¤
                    }
                    select.appendChild(option);
                }

                // ã‚‚ã—ä»¥å‰ã®å€¤ãŒç¯„å›²å†…ã«ã‚ã‚Œã°å¾©å…ƒ
                if (currentValue && currentValue >= minHolidays && currentValue <= maxHolidays) {
                    select.value = currentValue;
                }
            });
        }

        // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        function collectInputData() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const staffNames = [
                staff1Input.value || 'A',
                staff2Input.value || 'B',
                staff3Input.value || 'C'
            ];

            const targetHolidays = {};
            targetHolidays[staffNames[0]] = parseInt(document.getElementById('staff1Holidays').value);
            targetHolidays[staffNames[1]] = parseInt(document.getElementById('staff2Holidays').value);
            targetHolidays[staffNames[2]] = parseInt(document.getElementById('staff3Holidays').value);

            const daysInMonth = new Date(year, month, 0).getDate();
            const scheduleData = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayName = DAY_NAMES[date.getDay()];

                const dayData = {
                    day: day,
                    dayOfWeek: dayName,
                    staff: {}
                };

                for (let s = 1; s <= 3; s++) {
                    const cell = document.querySelector(`.off-cell[data-day="${day}"][data-staff="${s}"]`);
                    dayData.staff[staffNames[s - 1]] = cell.textContent;
                }

                scheduleData.push(dayData);
            }

            return {
                year: year,
                month: month,
                staffNames: staffNames,
                targetHolidays: targetHolidays,
                schedule: scheduleData
            };
        }

        // ç”Ÿæˆãƒœã‚¿ãƒ³
        generateBtn.addEventListener('click', async () => {
            loadingOverlay.style.display = 'flex';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';

            const inputData = collectInputData();

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(inputData)
                });

                const data = await response.json();

                if (data.success) {
                    showResult(data);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        function showResult(data) {
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿å­˜
            if (data.filename) {
                resultSection.dataset.filename = data.filename;
            }

            const yCountsDiv = document.getElementById('yCounts');
            yCountsDiv.innerHTML = '';
            for (const [name, count] of Object.entries(data.y_counts)) {
                const item = document.createElement('div');
                item.className = 'y-count-item';
                item.innerHTML = `<span class="name">${name}</span><span class="count">${count}å›</span>`;
                yCountsDiv.appendChild(item);
            }

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
            const previewHead = document.getElementById('previewHead');
            const previewBody = document.getElementById('previewBody');

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            previewHead.innerHTML = `
                <tr>
                    <th>æ—¥ä»˜</th>
                    <th>æ›œæ—¥</th>
                    ${data.staffNames.map(name => `<th colspan="2">${name}</th>`).join('')}
                </tr>
            `;

            // ãƒœãƒ‡ã‚£
            previewBody.innerHTML = '';
            for (const row of data.preview) {
                const dayOfWeek = row.dayOfWeek;
                const isWeekend = dayOfWeek === 'åœŸ' || dayOfWeek === 'æ—¥';

                let rowHtml = `
                    <tr class="${isWeekend ? 'weekend-row' : ''}">
                        <td class="day-cell">${row.day}</td>
                        <td class="day-name-cell ${isWeekend ? 'weekend' : ''}">${dayOfWeek}</td>
                `;

                for (const staffName of data.staffNames) {
                    const staffData = row.staff[staffName] || { value: '', isRequest: false };
                    const value = staffData.value;
                    const isRequest = staffData.isRequest;

                    let yMark = '';
                    let timeValue = value;

                    if (value.startsWith('Y')) {
                        yMark = 'Y';
                        timeValue = value.substring(1);
                    } else if (value === 'å…¬' || value === 'å¹´') {
                        yMark = '';
                        timeValue = value;
                    }

                    const yClass = yMark ? 'has-y' : '';
                    const offClass = (value === 'å…¬' || value === 'å¹´') ? 'is-off' : '';
                    const requestClass = isRequest ? 'request-off' : '';

                    rowHtml += `
                        <td class="preview-cell ${yClass} editable-cell y-column-cell" onclick="toggleY(this)">${yMark}</td>
                        <td class="preview-cell ${offClass} ${requestClass} editable-cell" onclick="editTime(this)" data-original-request="${isRequest}">${timeValue}</td>
                    `;
                }

                rowHtml += '</tr>';
                previewBody.innerHTML += rowHtml;
            }

            resultSection.style.display = 'block';

            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // --- ç·¨é›†æ©Ÿèƒ½ ---

        function toggleY(td) {
            if (td.textContent.trim() === 'Y') {
                td.textContent = '';
                td.classList.remove('has-y');
            } else {
                td.textContent = 'Y';
                td.classList.add('has-y');
            }
        }

        function editTime(td) {
            // ã™ã§ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (td.querySelector('select')) return;

            const currentValue = td.textContent.trim();
            td.innerHTML = '';

            const select = document.createElement('select');
            select.className = 'edit-select';

            const options = ['9', '10', 'å…¬', 'å¹´'];
            // ã‚‚ã—ç¾åœ¨ã®å€¤ãŒä¸Šè¨˜ä»¥å¤–ãªã‚‰ï¼ˆä¾‹: ç©ºæ¬„ãªã©ï¼‰ã€ãã‚Œã‚‚è¿½åŠ ã™ã‚‹ã‹ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ9ã«ã™ã‚‹ã‹
            if (!options.includes(currentValue) && currentValue !== '') {
                options.push(currentValue);
            }

            for (const opt of options) {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (opt === currentValue) option.selected = true;
                select.appendChild(option);
            }

            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰ç¢ºå®š
            select.addEventListener('blur', () => confirmEdit(td, select));
            // å¤‰æ›´æ™‚ã«ã‚‚ç¢ºå®šã™ã‚‹å ´åˆã¯ã“ã“ï¼ˆä»Šå›ã¯blurã ã‘ã§ã„ã„ã‹ã‚‚ã ãŒã€ä½¿ã„å‹æ‰‹çš„ã«Enterå¯¾å¿œç­‰ãŒæœ›ã¾ã—ã„ï¼‰
            select.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') select.blur();
            });

            td.appendChild(select);
            select.focus();
        }

        function confirmEdit(td, select) {
            const newValue = select.value;
            td.textContent = newValue;

            // ã‚¯ãƒ©ã‚¹æ›´æ–°
            td.classList.remove('is-off', 'request-off'); // request-offã‚‚ä¸€æ—¦å¤–ã™ï¼ˆç·¨é›†ã—ãŸæ™‚ç‚¹ã§æ‰‹å‹•ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã¨ã¿ãªã™ï¼‰

            if (newValue === 'å…¬' || newValue === 'å¹´') {
                td.classList.add('is-off');
                // å…ƒã€…ãŒå¸Œæœ›ä¼‘ã ã£ãŸå ´åˆã¯ã€å…¬/å¹´ã‚’é¸ã‚“ã§ã„ã‚‹é™ã‚Šrequest-offã‚’ç¶­æŒã—ãŸã„å ´åˆã‚‚ã‚ã‚‹ãŒ
                // ã“ã“ã§ã¯ã€Œç·¨é›†å¾Œã®ã‚¹ã‚¿ã‚¤ãƒ«ã€ã¨ã—ã¦ã€ã‚·ãƒ³ãƒ—ãƒ«ã« is-off ã®ã¿ã‚’é©ç”¨ï¼ˆèµ¤å­—ï¼‰ã€‚
                // ã‚‚ã—ç°è‰²ã«ã—ãŸã„ãªã‚‰ã“ã“ã§ request-off ã‚’è¶³ã›ã°è‰¯ã„ãŒã€
                // ã€Œæ‰‹å‹•ã§å…¬ã«ã—ãŸã€ã“ã¨ã‚’æ˜ç¢ºã«ã™ã‚‹ãªã‚‰è‰²ã‚’å¤‰ãˆã‚‹ã®ã‚‚æ‰‹ã€‚
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã€Œå…¬ã‚’å…¥åŠ›ã™ã‚‹ã‚»ãƒ«ã ã‘ç°è‰²ã€ã«å¾“ã†ãªã‚‰ï¼š
                if (newValue === 'å…¬') {
                    td.classList.add('request-off'); // å…¬ã‚’é¸ã‚“ã ã‚‰ç°è‰²ã«ã™ã‚‹
                }
            }

            // å¹´ã®å ´åˆã¯ï¼Ÿè¦æœ›ã¯ã€Œå…¬ã‚’å…¥åŠ›ã™ã‚‹ã‚»ãƒ«ã€ãªã®ã§ã€å¹´ã«ã¤ã„ã¦ã¯è¨€åŠãªã—ã€‚
            // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã§ã¯ isRequest=true ãªã‚‰ç°è‰²ã€‚å…¬ã‚‚å¹´ã‚‚ã€‚
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå…¬ã€ãªã‚‰ç°è‰²ã‚’ã¤ã‘ã¦ãŠãã€‚
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorSection.style.display = 'block';
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆç·¨é›†å†…å®¹ã‚’åæ˜ ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            const table = document.querySelector('.preview-table');
            if (!table) return;

            const staffNames = Array.from(table.querySelectorAll('thead th')).slice(2).map(th => th.textContent);
            const rows = [];
            const trs = table.querySelectorAll('tbody tr');

            for (const tr of trs) {
                const day = tr.querySelector('.day-cell').textContent;
                const dayOfWeek = tr.querySelector('.day-name-cell').textContent;
                const staffData = {};

                // ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚»ãƒ«ã¯2ã¤ãšã¤ (3ç•ªç›®ä»¥é™ã®td)
                const cells = Array.from(tr.querySelectorAll('.preview-cell'));

                for (let i = 0; i < staffNames.length; i++) {
                    const yCell = cells[i * 2];
                    const valCell = cells[i * 2 + 1];

                    const yVal = yCell.textContent.trim(); // 'Y' or ''
                    const timeVal = valCell.textContent.trim(); // '9', '10', 'å…¬' etc

                    // çµåˆã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ã‚‹å½¢å¼ã«ã™ã‚‹ ('Y9', '10', 'å…¬' ãªã©)
                    let fullVal = '';
                    if (timeVal === 'å…¬' || timeVal === 'å¹´') {
                        fullVal = timeVal;
                    } else {
                        // å‡ºå‹¤
                        fullVal = yVal + timeVal;
                    }

                    // isRequestã®åˆ¤å®š
                    // originalRequestãŒtrueã§ã€ã‹ã¤å€¤ãŒå…¬/å¹´ï¼ˆã¤ã¾ã‚Šä¼‘ã¿ï¼‰ã®å ´åˆã®ã¿ç¶­æŒ
                    // å‡ºå‹¤ã«å¤‰æ›´ã—ãŸãªã‚‰requestã˜ã‚ƒãªã„
                    const originalRequest = valCell.dataset.originalRequest === 'true';
                    let isRequest = originalRequest;

                    if (timeVal !== 'å…¬' && timeVal !== 'å¹´') {
                        isRequest = false;
                    }

                    staffData[staffNames[i]] = {
                        value: fullVal,
                        isRequest: isRequest
                    };
                }

                rows.push({
                    day: day,
                    dayOfWeek: dayOfWeek,
                    staff: staffData
                });
            }

            // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
            try {
                const response = await fetch('/download_edited', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rows: rows,
                        staffNames: staffNames,
                        filename: document.getElementById('resultSection').dataset.filename || 'schedule.xlsx'
                    })
                });

                if (!response.ok) {
                    throw new Error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = document.getElementById('resultSection').dataset.filename || 'å‹¤å‹™è¡¨.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (err) {
                alert(err.message);
            }
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>

</html>